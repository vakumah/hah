name: Windows RDP Optimization V7.4

on:
  workflow_dispatch:

jobs:
  setup:
    runs-on: windows-11-arm

    steps:
    - uses: actions/checkout@v2

    - name: System Performance
      run: |
        # High Performance Power Plan
        powercfg /s 8c5e7fda-e8bf-4a96-9a85-a6e23a8c635c
        
        # Disable CPU Throttling
        powercfg /setacvalueindex scheme_current sub_processor PROCTHROTTLEMIN 100
        powercfg /setactive scheme_current
        
        # Pagefile 8GB
        Set-CimInstance -Query "Select * from Win32_ComputerSystem" -Property @{AutomaticManagedPagefile=$False}
        $pagefile = Get-CimInstance -ClassName Win32_PageFileSetting -ErrorAction SilentlyContinue
        if ($pagefile) {
            Set-CimInstance -InputObject $pagefile -Property @{InitialSize=8192; MaximumSize=8192}
        } else {
            New-CimInstance -ClassName Win32_PageFileSetting -Property @{Name="C:\pagefile.sys"; InitialSize=8192; MaximumSize=8192}
        }

        # Disable Visual Effects
        $desktop = 'HKCU:\Control Panel\Desktop'
        Set-ItemProperty -Path $desktop -Name 'Wallpaper' -Value ""
        Set-ItemProperty -Path $desktop -Name 'UserPreferencesMask' -Value ([byte[]](0x90,0x12,0x01,0x80,0x10,0x00,0x00,0x00))
        Set-ItemProperty -Path $desktop -Name 'MenuShowDelay' -Value 0
        Set-ItemProperty -Path $desktop -Name 'FontSmoothing' -Value 0
        Set-ItemProperty -Path $desktop -Name 'DragFullWindows' -Value 0
        Set-ItemProperty -Path 'HKCU:\Control Panel\Colors' -Name 'Background' -Value "0 0 0"

        # Best Performance Mode
        $vis = 'HKCU:\Software\Microsoft\Windows\CurrentVersion\Explorer\VisualEffects'
        if (!(Test-Path $vis)) { New-Item -Path $vis -Force }
        Set-ItemProperty -Path $vis -Name 'VisualFXSetting' -Value 2
        
        # Processor Scheduling - Programs priority
        Set-ItemProperty -Path 'HKLM:\SYSTEM\CurrentControlSet\Control\PriorityControl' -Name 'Win32PrioritySeparation' -Value 38

    - name: Disk Optimization
      run: |
        # Disable Last Access Time (faster file access)
        fsutil behavior set disablelastaccess 1
        
        # Disable 8.3 filename creation
        fsutil behavior set disable8dot3 1
        
        # Disable hibernation (free up disk space)
        powercfg /h off
        
        # Disable memory compression
        Disable-MMAgent -MemoryCompression -ErrorAction SilentlyContinue
        
        # Clean temp files
        Remove-Item -Path "$env:TEMP\*" -Recurse -Force -ErrorAction SilentlyContinue
        Remove-Item -Path "C:\Windows\Temp\*" -Recurse -Force -ErrorAction SilentlyContinue
        Remove-Item -Path "C:\Windows\Prefetch\*" -Recurse -Force -ErrorAction SilentlyContinue

    - name: Network Tuning
      run: |
        # Enable RSS & Autotuning
        netsh int tcp set global rss=enabled
        netsh int tcp set global autotuninglevel=normal
        netsh int tcp set global ecncapability=enabled
        
        # Enable Direct Cache Access
        netsh int tcp set global dca=enabled
        
        # Use Cloudflare DNS (faster resolution)
        $adapters = Get-NetAdapter | Where-Object {$_.Status -eq 'Up'}
        foreach ($adapter in $adapters) {
            Set-DnsClientServerAddress -InterfaceIndex $adapter.ifIndex -ServerAddresses ("1.1.1.1","1.0.0.1") -ErrorAction SilentlyContinue
        }
        
        # Disable Windows Firewall (faster network)
        Set-NetFirewallProfile -Profile Domain,Public,Private -Enabled False
        
        # TCP Optimizations
        $tcp = "HKLM:\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters\Interfaces"
        Get-ChildItem $tcp | ForEach-Object {
            New-ItemProperty -Path $_.PSPath -Name "TcpAckFrequency" -Value 1 -PropertyType DWord -Force -ErrorAction SilentlyContinue
            New-ItemProperty -Path $_.PSPath -Name "TCPNoDelay" -Value 1 -PropertyType DWord -Force -ErrorAction SilentlyContinue
        }
        
        # Global TCP settings
        $tcpParams = "HKLM:\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters"
        Set-ItemProperty -Path $tcpParams -Name "TcpTimedWaitDelay" -Value 30 -Type DWord -ErrorAction SilentlyContinue
        Set-ItemProperty -Path $tcpParams -Name "MaxUserPort" -Value 65534 -Type DWord -ErrorAction SilentlyContinue
        Set-ItemProperty -Path $tcpParams -Name "TcpMaxDataRetransmissions" -Value 3 -Type DWord -ErrorAction SilentlyContinue

    - name: Android Build Config
      run: |
        $gDir = "$env:USERPROFILE\.gradle"
        if (!(Test-Path $gDir)) { New-Item -Path $gDir -ItemType Directory }
        
        @"
        org.gradle.daemon=true
        org.gradle.parallel=true
        org.gradle.configureondemand=true
        org.gradle.workers.max=4
        org.gradle.caching=true
        org.gradle.jvmargs=-Xmx10g -XX:+UseParallelGC -XX:MaxMetaspaceSize=1g -XX:+HeapDumpOnOutOfMemoryError -Dfile.encoding=UTF-8
        android.enableBuildCache=true
        android.useAndroidX=true
        kotlin.incremental=true
        kotlin.code.style=official
        "@ | Out-File -FilePath "$gDir\gradle.properties" -Encoding ascii
        
        [Environment]::SetEnvironmentVariable("JAVA_OPTS", "-Xmx10g -XX:+UseParallelGC", "Machine")
        [Environment]::SetEnvironmentVariable("GRADLE_OPTS", "-Xmx2g -Dorg.gradle.daemon=true", "Machine")

    - name: Security & Services
      run: |
        # Disable Defender
        Set-MpPreference -DisableRealtimeMonitoring $true
        Set-MpPreference -DisableBehaviorMonitoring $true
        Set-MpPreference -DisableBlockAtFirstSeen $true
        Set-MpPreference -DisableIOAVProtection $true
        Set-MpPreference -DisableScriptScanning $true
        Set-MpPreference -MAPSReporting 0
        
        # Disable more unnecessary services
        $svcs = @(
            "WSearch",
            "SysMain",
            "wuauserv",
            "BITS",
            "Themes",
            "WerSvc",
            "ShellHWDetection",
            "DiagTrack",
            "dmwappushservice",
            "MapsBroker",
            "PhoneSvc",
            "TabletInputService",
            "WbioSrvc",
            "icssvc",
            "lfsvc",
            "WMPNetworkSvc"
        )
        foreach ($s in $svcs) {
            Stop-Service -Name $s -Force -ErrorAction SilentlyContinue
            Set-Service -Name $s -StartupType Disabled -ErrorAction SilentlyContinue
        }
        
        # Disable Scheduled Tasks
        Get-ScheduledTask -TaskPath '\Microsoft\Windows\*' | Where-Object {$_.State -ne 'Disabled'} | Disable-ScheduledTask -ErrorAction SilentlyContinue

    - name: Dark Mode & UI
      run: |
        # Enable Dark Mode
        $themes = 'HKCU:\SOFTWARE\Microsoft\Windows\CurrentVersion\Themes\Personalize'
        if (!(Test-Path $themes)) { New-Item -Path $themes -Force }
        Set-ItemProperty -Path $themes -Name 'AppsUseLightTheme' -Value 0
        Set-ItemProperty -Path $themes -Name 'SystemUsesLightTheme' -Value 0
        
        # Disable transparency
        Set-ItemProperty -Path $themes -Name 'EnableTransparency' -Value 0
        
        # Disable Notifications
        $notif = 'HKCU:\SOFTWARE\Microsoft\Windows\CurrentVersion\PushNotifications'
        if (!(Test-Path $notif)) { New-Item -Path $notif -Force }
        Set-ItemProperty -Path $notif -Name 'ToastEnabled' -Value 0
        
        # Disable Action Center
        $explorer = 'HKCU:\SOFTWARE\Policies\Microsoft\Windows\Explorer'
        if (!(Test-Path $explorer)) { New-Item -Path $explorer -Force }
        Set-ItemProperty -Path $explorer -Name 'DisableNotificationCenter' -Value 1
        
        # Disable Cortana
        $cortana = 'HKLM:\SOFTWARE\Policies\Microsoft\Windows\Windows Search'
        if (!(Test-Path $cortana)) { New-Item -Path $cortana -Force }
        Set-ItemProperty -Path $cortana -Name 'AllowCortana' -Value 0

    - name: Game Mode & GPU Priority
      run: |
        # Enable Game Mode
        $gameMode = 'HKCU:\SOFTWARE\Microsoft\GameBar'
        if (!(Test-Path $gameMode)) { New-Item -Path $gameMode -Force }
        Set-ItemProperty -Path $gameMode -Name 'AllowAutoGameMode' -Value 1
        Set-ItemProperty -Path $gameMode -Name 'AutoGameModeEnabled' -Value 1
        
        # GPU Priority for better graphics
        $gpu = 'HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Multimedia\SystemProfile'
        Set-ItemProperty -Path $gpu -Name 'SystemResponsiveness' -Value 0
        Set-ItemProperty -Path $gpu -Name 'NetworkThrottlingIndex' -Value 0xFFFFFFFF
        
        # GPU Scheduling
        $gpuTask = 'HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Multimedia\SystemProfile\Tasks\Games'
        if (!(Test-Path $gpuTask)) { New-Item -Path $gpuTask -Force }
        Set-ItemProperty -Path $gpuTask -Name 'GPU Priority' -Value 8
        Set-ItemProperty -Path $gpuTask -Name 'Priority' -Value 6
        Set-ItemProperty -Path $gpuTask -Name 'Scheduling Category' -Value 'High'
        Set-ItemProperty -Path $gpuTask -Name 'SFIO Priority' -Value 'High'

    - name: Input Lag Reduction
      run: |
        # Mouse optimization
        $mouse = 'HKCU:\Control Panel\Mouse'
        Set-ItemProperty -Path $mouse -Name 'MouseSpeed' -Value 0
        Set-ItemProperty -Path $mouse -Name 'MouseThreshold1' -Value 0
        Set-ItemProperty -Path $mouse -Name 'MouseThreshold2' -Value 0
        Set-ItemProperty -Path $mouse -Name 'MouseSensitivity' -Value 10
        
        # Keyboard optimization
        $keyboard = 'HKCU:\Control Panel\Keyboard'
        Set-ItemProperty -Path $keyboard -Name 'KeyboardDelay' -Value 0
        Set-ItemProperty -Path $keyboard -Name 'KeyboardSpeed' -Value 31
        
        # Reduce input buffer
        $input = 'HKLM:\SYSTEM\CurrentControlSet\Services\mouclass\Parameters'
        Set-ItemProperty -Path $input -Name 'MouseDataQueueSize' -Value 0x10 -ErrorAction SilentlyContinue
        $kbInput = 'HKLM:\SYSTEM\CurrentControlSet\Services\kbdclass\Parameters'
        Set-ItemProperty -Path $kbInput -Name 'KeyboardDataQueueSize' -Value 0x10 -ErrorAction SilentlyContinue

    - name: Memory Optimization
      run: |
        # Large System Cache
        $memory = 'HKLM:\SYSTEM\CurrentControlSet\Control\Session Manager\Memory Management'
        Set-ItemProperty -Path $memory -Name 'LargeSystemCache' -Value 0
        Set-ItemProperty -Path $memory -Name 'DisablePagingExecutive' -Value 1
        Set-ItemProperty -Path $memory -Name 'ClearPageFileAtShutdown' -Value 0
        
        # Optimize working set
        Set-ItemProperty -Path $memory -Name 'SystemPages' -Value 0
        
        # NDU (Network Data Usage) - causes memory leak
        Set-ItemProperty -Path 'HKLM:\SYSTEM\ControlSet001\Services\Ndu' -Name 'Start' -Value 4 -ErrorAction SilentlyContinue

    - name: Taskbar Customization
      run: |
        # Move Taskbar to Top (Windows 11 / Server 2025)
        $regPath = "HKCU:\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\StuckRects3"
        
        # Get current settings
        $settings = (Get-ItemProperty -Path $regPath -Name Settings -ErrorAction SilentlyContinue).Settings
        
        if ($settings) {
            # Byte 12 controls position: 00=Left, 01=Top, 02=Right, 03=Bottom
            $settings[12] = 0x01  # Set to Top
            Set-ItemProperty -Path $regPath -Name Settings -Value $settings
        } else {
            # Create default settings with taskbar at top
            $defaultSettings = @(
                0x30,0x00,0x00,0x00,0xFE,0xFF,0xFF,0xFF,
                0x02,0x00,0x00,0x00,0x01,0x00,0x00,0x00,  # Byte 12 = 0x01 (Top)
                0x3E,0x00,0x00,0x00,0x2E,0x00,0x00,0x00,
                0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
                0x80,0x07,0x00,0x00,0x30,0x00,0x00,0x00
            )
            if (!(Test-Path $regPath)) { New-Item -Path $regPath -Force }
            Set-ItemProperty -Path $regPath -Name Settings -Value ([byte[]]$defaultSettings)
        }
        
        # Restart Explorer to apply changes
        Stop-Process -Name explorer -Force -ErrorAction SilentlyContinue
        Start-Sleep -Seconds 2
        Start-Process explorer

    - name: RDP Low Latency Setup
      run: |
        $ts = 'HKLM:\System\CurrentControlSet\Control\Terminal Server'
        Set-ItemProperty -Path $ts -Name "fDenyTSConnections" -Value 0
        Set-ItemProperty -Path "$ts\WinStations\RDP-Tcp" -Name "UserAuthentication" -Value 0
        
        # RDP Policy optimizations
        $rdpPol = "HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\Terminal Services"
        if (!(Test-Path $rdpPol)) { New-Item -Path $rdpPol -Force }
        Set-ItemProperty -Path $rdpPol -Name "ColorDepth" -Value 3
        Set-ItemProperty -Path $rdpPol -Name "fDisableCursorShadow" -Value 1
        Set-ItemProperty -Path $rdpPol -Name "fDisableMenuAnims" -Value 1
        Set-ItemProperty -Path $rdpPol -Name "fDisableThemes" -Value 1
        Set-ItemProperty -Path $rdpPol -Name "fDisableWallpaper" -Value 1
        Set-ItemProperty -Path $rdpPol -Name "fEnableVirtualizedGraphics" -Value 0
        
        # Enable UDP transport for lower latency
        Set-ItemProperty -Path $rdpPol -Name "SelectTransport" -Value 0
        Set-ItemProperty -Path $rdpPol -Name "fDisableAudioCapture" -Value 1
        
        # RDP compression
        Set-ItemProperty -Path "$ts\WinStations\RDP-Tcp" -Name "fDisableEncryption" -Value 0
        
        Set-LocalUser -Name "runneradmin" -Password (ConvertTo-SecureString -AsPlainText "p@ssw0rd!" -Force)

    - name: Tunnel
      env:
        PL_KEY: ${{ secrets.PL }}
      run: |
        $url = "https://github.com/playit-cloud/playit-agent/releases/download/v0.15.26/playit-windows-x86_64-signed.exe"
        Invoke-WebRequest -Uri $url -OutFile "$env:USERPROFILE\playit.exe"
        Start-Process -FilePath "$env:USERPROFILE\playit.exe" -ArgumentList "--secret $env:PL_KEY" -WindowStyle Hidden

    - name: Keep Alive
      run: |
        while ($true) {
            if (!(Get-Process -Name "playit" -ErrorAction SilentlyContinue)) {
                Start-Process -FilePath "$env:USERPROFILE\playit.exe" -ArgumentList "--secret ${{ secrets.PL }}" -WindowStyle Hidden
            }
            Write-Host "Monitoring... (CPU & Connection OK)"
            Start-Sleep -Seconds 60
        }
