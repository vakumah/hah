name: macOS GUI Bypass Force
on: workflow_dispatch

jobs:
  gui-access:
    runs-on: macos-latest
    steps:
      - name: Install Network Tools
        run: brew install bore-cli

      - name: Force Bypass Setup
        run: |
          # 1. Reset & Paksa Aktifkan ARD (Remote Management)
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart -deactivate -stop
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart -activate -configure -access -on -users runner -privs -all -restart -agent
          
          # 2. Bypass VNC Login (Legacy Password)
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart -configure -clientopts -setvnclegacy -vnclegacy yes -setvncpw -vncpw Password123

          # 3. Disable Screen Lock & Sleep (Force)
          sudo defaults write com.apple.loginwindow DisableScreenLock -bool true
          sudo defaults write com.apple.screensaver idleTime 0
          sudo systemsetup -setdisplaysleep off > /dev/null 2>&1
          
          # 4. Ambil kepemilikan WindowServer (Bypass Black Screen)
          sudo chown root:admin /Library/Preferences/com.apple.windowserver.plist || true

      - name: Start Tunnel
        run: |
          bore local 5900 --to bore.pub &
          sleep 10

      - name: Auto-Unlocker (The Bypass)
        run: |
          echo "Bypass aktif... Menunggu koneksi VNC..."
          echo "Host: bore.pub"
          echo "VNC Password: Password123"
          
          # Loop ini akan memaksa sistem 'mengetik' password setiap 15 detik 
          # untuk menjebol layar login yang hitam/stuck.
          (while true; do
            # Simulasi tekan Enter -> Ketik Password -> Enter
            osascript -e 'tell application "System Events" to key code 36'
            sleep 2
            osascript -e 'tell application "System Events" to keystroke "Password123"'
            sleep 2
            osascript -e 'tell application "System Events" to key code 36'
            echo "Sent Force Unlock command..."
            sleep 15
          done) &
          
          # Menjaga runner aktif selama 6 jam
          sleep 21600
