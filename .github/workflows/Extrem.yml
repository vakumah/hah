name: macOS 13 GUI Force
on: workflow_dispatch

jobs:
  gui-access:
    runs-on: macos-13
    steps:
      - name: Install Tools
        run: brew install bore-cli

      - name: Setup Remote Management
        run: |
          # Aktifkan ARD dan VNC dengan Password Legacy
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart -activate -configure -access -on -users runner -privs -all -restart -agent
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart -configure -clientopts -setvnclegacy -vnclegacy yes -setvncpw -vncpw Password123
          
          # Matikan Sleep dan Screen Saver agar layar tidak terkunci
          sudo systemsetup -setdisplaysleep off > /dev/null 2>&1
          sudo systemsetup -setsleep off > /dev/null 2>&1
          sudo defaults write com.apple.screensaver idleTime 0

      - name: Start Tunnel
        run: |
          # Jalankan Bore di port 5900 (VNC)
          bore local 5900 --to bore.pub &
          sleep 10

      - name: Force Wake & Info
        run: |
          echo "================================================"
          echo "IMAGE: macOS 13 (Ventura)"
          echo "HOST: bore.pub"
          echo "VNC PASSWORD: Password123"
          echo "================================================"
          
          # Teknik pancingan agar WindowServer merender desktop
          sudo launchctl kickstart -kp system/com.apple.WindowServer
          
          # Loop Auto-Unlocker: Mengetik password otomatis jika layar stuck hitam
          (while true; do
            # Tekan Enter -> Ketik Password -> Enter
            osascript -e 'tell application "System Events" to key code 36'
            sleep 2
            osascript -e 'tell application "System Events" to keystroke "Password123"'
            sleep 2
            osascript -e 'tell application "System Events" to key code 36'
            sleep 30
          done) &
          
          # Menjaga runner tetap aktif selama 6 jam
          sleep 21600
