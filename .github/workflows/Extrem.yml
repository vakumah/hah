name: Windows Emulator Challenge

on: workflow_dispatch

jobs:
  windows-test:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      # 1. Cek Info Sistem & Virtualisasi
      - name: Check System Info (Virtualization Support)
        run: |
          echo "Checking System Info..."
          systeminfo | findstr /C:"Virtualization Available In Firmware" /C:"Hyper-V Requirements"
          
          echo "Checking CPU Flags (Intel VMX or AMD SVM)..."
          # Kita pakai tool coreinfo (download dulu) untuk cek flag CPU
          Invoke-WebRequest -Uri "https://download.sysinternals.com/files/Coreinfo.zip" -OutFile "Coreinfo.zip"
          Expand-Archive Coreinfo.zip -DestinationPath .
          ./Coreinfo64.exe -v

      # 2. Coba Setup Android SDK
      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      # 3. Coba Install HAXM (Intel Hardware Accelerator)
      # Biasanya ini akan GAGAL di Windows Runner karena 'VT-x not enabled'
      - name: Try Install HAXM / Hyper-V
        continue-on-error: true  # Lanjut meskipun error (biar kita lihat lognya)
        run: |
          echo "Trying to install HAXM..."
          $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager "extras;intel;Hardware_Accelerated_Execution_Manager"
          
          echo "Check if HAXM installer exists..."
          ls $ANDROID_HOME/extras/intel/Hardware_Accelerated_Execution_Manager/

      # 4. Coba Jalankan Emulator
      - name: Run Emulator (Will Fail or be Slow)
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 29
          target: default
          arch: x86_64
          # Kita coba paksa pakai host GPU
          emulator-options: -no-window -gpu host -noaudio -no-boot-anim -accel on
          script: echo "Emulator Started!"
          
