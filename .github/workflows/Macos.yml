name: macOS GUI 24/7 + noVNC + LocalTunnel

on:
  workflow_dispatch:
  schedule:
    - cron: '*/350 * * * *'

jobs:
  gui:
    runs-on: macos-14
    timeout-minutes: 360

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          brew install node
          npm install -g localtunnel
          git clone https://github.com/novnc/noVNC.git

      - name: Setup noVNC Auto-Connect
        run: |
          cd noVNC
          cp vnc.html index.html
          cat > index.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
            <title>macOS GUI</title>
            <meta http-equiv="refresh" content="0; url=vnc.html?host=localhost&port=5901&autoconnect=true&password=gui12345">
          </head>
          <body><p>Loading GUI...</p></body>
          </html>
          EOF

      - name: Enable VNC and Set Password
        run: |
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -activate -configure -access -on -privs -all -setvncpw -vncpw "gui12345"

      - name: Start noVNC Server
        run: |
          cd noVNC
          nohup python3 -m http.server 6080 > ../novnc.log 2>&1 &
          sleep 5

      - name: Start LocalTunnel
        run: |
          nohup lt --port 6080 --local-host 127.0.0.1 --print-url > tunnel.log 2>&1 &
          sleep 12
          URL=$(grep -o 'https://[^[:space:]]*' tunnel.log | head -1 || echo "https://localhost")
          echo "TUNNEL_URL=$URL" >> $GITHUB_OUTPUT
          echo "GUI URL: $URL"

      - name: Show Access Info
        run: |
          echo "=================================="
          echo "MACOS GUI 24/7 SIAP!"
          echo "=================================="
          echo "Buka di browser:"
          echo "$TUNNEL_URL"
          echo ""
          echo "1. Password: gui12345"
          echo "2. Kosongkan IP Address"
          echo "3. Klik 'Click' → langsung masuk"
          echo ""
          echo "Auto-restart tiap 5 jam 50 menit"
          echo "=================================="

      - name: Keep Alive
        run: |
          echo "Runner hidup... Auto-restart via cron."
          while true; do
            sleep 300
            echo "[$(date)] Still alive → $TUNNEL_URL"
          done
