name: Localtunnel VNC Tunnel (macOS - 100% Free)
on:
  workflow_dispatch:

jobs:
  setup-vnc-tunnel:
    runs-on: macos-14  # atau macos-latest
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v2

    - name: Install Node.js & Localtunnel
      uses: actions/setup-node@v4
      with:
        node-version: '20'
      run: |
        npm install -g localtunnel

    - name: Enable Screen Sharing (VNC)
      run: |
        sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
          -activate -configure -access -on \
          -users admin -privs -all -restart -agent -menu
        echo "Screen Sharing (VNC) enabled on port 5900"

    - name: Set VNC Password (via Expect)
      run: |
        # Install expect if needed (macOS has it)
        EXPECT_SCRIPT=$(cat << 'EOF'
        spawn sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart -configure -clientopts -setvnclegacy -vnclegacy yes
        expect "Password:"
        send "macvnc123!\r"
        expect "Verify:"
        send "macvnc123!\r"
        expect eof
        EOF
        )
        expect -c "$EXPECT_SCRIPT"

    - name: Optimize macOS for Remote Access
      run: |
        # Disable animations
        defaults write com.apple.finder DisableAllAnimations -bool true
        defaults write NSGlobalDomain NSAutomaticWindowAnimationsEnabled -bool false
        defaults write com.apple.universalaccess reduceTransparency -bool true
        
        # Disable sleep
        sudo systemsetup -setcomputersleep Never
        sudo pmset -a autopoweroff 0
        sudo pmset -a powernap 0
        sudo pmset -a standby 0
        sudo pmset -a hibernatemode 0

        # Kill heavy processes
        pkill -f "Spotlight" || true

    - name: Start VNC + Localtunnel (with SSH Forward for TCP)
      run: |
        # Start SSH server for local forwarding (if not already)
        sudo systemsetup -setremotelogin on
        
        # Create SSH key for local forward (tunnel VNC via local port)
        ssh-keygen -t rsa -f ~/.ssh/id_rsa -N "" -q
        
        # Background: Start localtunnel on a dummy HTTP port, but use SSH for VNC forward
        # (Localtunnel HTTP, but for VNC TCP: Use SSH tunnel to forward 5900 to a local HTTP proxy if needed; here simple SSH local forward)
        echo "Starting SSH local forward for VNC (port 5900)..."
        
        # Run SSH in background to forward local 5900 to remote 5900 (but since local, it's identity)
        # Actually, for external: Localtunnel exposes SSH port 22, then client SSH tunnel to VNC
        lt --port 22 --subdomain myvnc-tunnel-$GITHUB_RUN_ID &  # Expose SSH for tunnel
        LT_PID=$!
        sleep 10
        
        # Get LT URL
        LT_URL=$(curl -s http://localhost:4040/api/tunnels | grep -o 'https://[^"]*')
        echo "Localtunnel URL (for SSH): $LT_URL"
        echo "TUNNEL_URL=$LT_URL" >> $GITHUB_ENV
        
        # Keep alive
        wait $LT_PID

    - name: Display Connection Instructions
      run: |
        echo "=== MACOS VNC VIA LOCALTUNNEL (FREE) ==="
        echo "1. SSH to tunnel: ssh -L 5900:localhost:5900 runner@$LT_URL"
        echo "2. Then VNC to: vnc://localhost:5900"
        echo "Password: macvnc123!"
        echo "=================================="

    - name: Keep Runner Alive
      run: |
        echo "Tunnel active... Sleeping forever."
        while true; do sleep 300; done
