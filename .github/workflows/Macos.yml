name: macOS-GUI-Serveo-Fixed

on:
  workflow_dispatch:

jobs:
  macos:
    runs-on: macos-latest

    steps:
      - name: Enable VNC
        run: |
          sudo launchctl load -w /System/Library/LaunchDaemons/com.apple.screensharing.plist
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -activate -configure -access -on \
            -clientopts -setvnclegacy -vnclegacy yes \
            -clientopts -setvncpw -vncpw "123456" \
            -restart -agent -privs -all
          echo "VNC password = 123456"

      - name: Start Serveo Tunnel (No Crash)
        run: |
          echo "Starting Serveo tunnel..."
          while true; do
            ssh -o StrictHostKeyChecking=no \
                -o ServerAliveInterval=60 \
                -R 5900:localhost:5900 serveo.net \
                2>&1 | tee serveo.log
            echo "SSH disconnected... retrying in 3 seconds"
            sleep 3
          done &
          sleep 8
          echo "======= SERVEO INFO ======="
          cat serveo.log | grep -Eo "Forwarding.*"

      - name: Keep Runner Alive
        run: |
          echo "Runner alive for 12 hours"
          sleep 43200
