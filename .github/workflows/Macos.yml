name: macOS-VNC-LocalTunnel

on:
  workflow_dispatch:

jobs:
  macos:
    runs-on: macos-latest

    steps:
      - name: Enable VNC
        run: |
          sudo launchctl load -w /System/Library/LaunchDaemons/com.apple.screensharing.plist
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -activate -configure -access -on \
            -clientopts -setvnclegacy -vnclegacy yes \
            -clientopts -setvncpw -vncpw "123456" \
            -restart -agent -privs -all
          echo "VNC password = 123456"

      - name: Install LocalTunnel
        run: |
          npm install -g localtunnel

      - name: Start LocalTunnel for VNC
        run: |
          echo "Starting LocalTunnel on port 5900..."
          lt --port 5900 --print-requests > lt.log 2>&1 &
          sleep 5
          echo "===== LOCAL TUNNEL URL ====="
          cat lt.log | grep https

      - name: Keep Runner Alive
        run: |
          echo "Runner alive for 12 hours"
          sleep 43200
