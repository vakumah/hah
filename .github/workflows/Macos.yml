name: macOS GUI 24/7 + noVNC + LocalTunnel (FIXED)

on:
  workflow_dispatch:
  schedule:
    - cron: '*/350 * * * *'  # Auto-restart tiap 5 jam 50 menit

jobs:
  gui:
    runs-on: macos-14
    timeout-minutes: 360

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          brew install node
          npm install -g localtunnel
          git clone https://github.com/novnc/noVNC.git
          cd noVNC
          cp vnc.html index.html
          # Auto-connect + bypass
          sed -i '' 's|</head>|<script>window.addEventListener("load", function(){ setTimeout(function(){ document.querySelector("connect").click(); }, 2000); });</script></head>|' index.html

      - name: Enable VNC
        run: |
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -activate -configure -access -on -privs -all -setvncpw -vncpw "gui12345"

      - name: Start noVNC
        run: |
          cd noVNC
          nohup python3 -m http.server 6080 > ../novnc.log 2>&1 &
          sleep 5

      - name: Start LocalTunnel (FIX: local-host 127.0.0.1)
        run: |
          nohup lt --port 6080 --local-host 127.0.0.1 --print-url > tunnel.log 2>&1 &
          sleep 12
          URL=$(grep -o 'https://[^ ]*' tunnel.log | head -1)
          echo "TUNNEL_URL=$URL" >> $GITHUB_OUTPUT
          echo "GUI URL: $URL"

      - name: Final URL
        run: |
          echo "=================================="
          echo "MACOS GUI 24/7 SIAP!"
          echo "=================================="
          echo "Buka: $TUNNEL_URL"
          echo ""
          echo "1. Masukkan password: gui12345"
          echo "2. Kosongkan IP → langsung klik 'Click'"
          echo "   (Abaikan 'valid IPv4' – bug LocalTunnel)"
          echo ""
          echo "Auto-restart tiap 5 jam 50 menit"
          echo "=================================="

      - name: Keep Alive
        run: |
          while true; do sleep 300; echo "[$(date)] Alive → $TUNNEL_URL"; done
