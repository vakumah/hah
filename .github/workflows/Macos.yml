name: macOS-GUI-Serveo

on:
  workflow_dispatch:

jobs:
  macos-gui:
    runs-on: macos-latest

    steps:
      - name: Enable VNC Screen Sharing
        run: |
          sudo launchctl load -w /System/Library/LaunchDaemons/com.apple.screensharing.plist
          sudo defaults write /Library/Preferences/com.apple.VNCSettings ControlDial -bool true
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -activate -configure -access -on \
            -clientopts -setvnclegacy -vnclegacy yes \
            -clientopts -setvncpw -vncpw "123456" \
            -restart -agent -privs -all
          echo "VNC Password set: 123456"

      - name: Install OpenSSH (macOS already has)
        run: |
          echo "SSH already installed."

      - name: Start Serveo Tunnel (port 5900)
        run: |
          echo "Starting Serveo tunnel..."
          ssh -o StrictHostKeyChecking=no -R 5900:localhost:5900 serveo.net > serveo.log 2>&1 &

          sleep 5
          echo "===== SERVEO URL ====="
          cat serveo.log | grep -Eo "https://[a-zA-Z0-9./_-]+"

      - name: Keep Runner Alive
        run: sleep 43200
