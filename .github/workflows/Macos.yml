name: MacOS VNC Pro – Localtunnel (FIXED & WORKING)
on:
  workflow_dispatch:

jobs:
  vnc-tunnel:
    runs-on: macos-14
    outputs:
      tunnel_url: ${{ steps.tunnel.outputs.url }}
      vnc_password: ${{ steps.password.outputs.pass }}
    steps:
      # =============================================
      # 1. Setup
      # =============================================
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Localtunnel
        run: npm install -g localtunnel

      # =============================================
      # 2. Generate Random Password
      # =============================================
      - name: Generate Random VNC Password
        id: password
        run: |
          PASS=$(openssl rand -base64 12 | tr -dc 'A-Za-z0-9!@#$%^&*' | head -c 16)
          echo "pass=$PASS" >> $GITHUB_OUTPUT
          echo "VNC Password: $PASS"

      # =============================================
      # 3. Enable VNC + Set Password (FIXED with sysadminctl)
      # =============================================
      - name: Enable VNC & Set Password (sysadminctl)
        env:
          VNC_PASS: ${{ steps.password.outputs.pass }}
        run: |
          # Create admin user 'vncuser' with password
          sudo sysadminctl -addUser vncuser -fullName "VNC User" -password "$VNC_PASS" -admin

          # Enable Remote Management
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -activate -configure -access -on -users vncuser -privs -all -restart -agent

          # Enable legacy VNC (port 5900)
          sudo defaults write /Library/Preferences/com.apple.VNCSettings.txt Legacy -bool true
          sudo defaults write /Library/Preferences/com.apple.VNCSettings.txt Authentication -string "VncAuth"

          # Generate VNC password hash
          HASH=$(printf "%s" "$VNC_PASS" | openssl dgst -sha1 -binary | xxd -p | tr 'a-f' 'A-F')
          sudo defaults write /Library/Preferences/com.apple.VNCSettings.txt Password -string "$HASH"

          # Restart agent
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart -restart -agent

          echo "VNC READY | User: vncuser | Pass: $VNC_PASS"

      # =============================================
      # 4. Optimize macOS
      # =============================================
      - name: Optimize for Remote
        run: |
          defaults write com.apple.finder DisableAllAnimations -bool true
          defaults write NSGlobalDomain NSAutomaticWindowAnimationsEnabled -bool false
          killall Finder 2>/dev/null || true

          sudo systemsetup -setcomputersleep Never 2>/dev/null || true
          sudo pmset -a autopoweroff 0
          sudo pmset -a powernap 0
          sudo pmset -a standby 0

      # =============================================
      # 5. Start SSH + Localtunnel
      # =============================================
      - name: Start Localtunnel + SSH
        id: tunnel
        run: |
          sudo systemsetup -setremotelogin on

          # SSH key
          mkdir -p /Users/vncuser/.ssh
          ssh-keygen -t ed25519 -f /Users/vncuser/.ssh/id_ed25519 -N "" -q
          sudo chown vncuser:staff /Users/vncuser/.ssh -R

          # Allow vncuser sudo
          echo "vncuser ALL=(ALL) NOPASSWD:ALL" | sudo tee /etc/sudoers.d/vncuser

          SUBDOMAIN="vncpro-${{ github.run_id }}-${{ github.run_attempt }}"
          lt --port 22 --subdomain "$SUBDOMAIN" > lt.log 2>&1 &
          LT_PID=$!
          echo "LT_PID=$LT_PID" >> $GITHUB_ENV

          sleep 15
          URL=$(grep -o 'https://[^ ]*' lt.log | head -1 || echo "https://$SUBDOMAIN.loca.lt")
          echo "url=$URL" >> $GITHUB_OUTPUT
          echo "TUNNEL_URL=$URL" >> $GITHUB_ENV

      # =============================================
      # 6. Summary
      # =============================================
      - name: Pin Connection Info
        uses: actions/github-script@v7
        env:
          URL: ${{ steps.tunnel.outputs.url }}
          PASS: ${{ steps.password.outputs.pass }}
        with:
          script: |
            core.summary
              .addHeading('MacOS VNC PRO – CONNECT NOW!', 2)
              .addRaw(`<p><strong>Tunnel URL:</strong> <code>${process.env.URL}</code></p>`)
              .addRaw(`<p><strong>Username:</strong> <code>vncuser</code></p>`)
              .addRaw(`<p><strong>Password:</strong> <code>${process.env.PASS}</code></p>`)
              .addRaw(`<hr><h3>Connect:</h3>`)
              .addRaw(`<ol>`)
              .addRaw(`<li><strong>SSH Tunnel:</strong><br>`)
              .addCodeBlock(`ssh -L 5900:localhost:5900 vncuser@${process.env.URL.replace('https://', '')}`, 'bash')
              .addRaw(`</li>`)
              .addRaw(`<li><strong>VNC:</strong> <code>vnc://localhost:5900</code></li>`)
              .addRaw(`</ol>`)
              .write();

      # =============================================
      # 7. Keep Alive
      # =============================================
      - name: Keep Alive
        run: |
          while true; do
            if ! pgrep -f "lt --port 22" > /dev/null; then
              SUBDOMAIN="vncpro-${{ github.run_id }}-${{ github.run_attempt }}"
              lt --port 22 --subdomain "$SUBDOMAIN" > lt.log 2>&1 &
            fi
            sleep 30
          done
