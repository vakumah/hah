name: macOS GUI 24/7 + noVNC + LocalTunnel

on:
  workflow_dispatch:
  schedule:
    - cron: '*/350 * * * *'  # Restart tiap 5 jam 50 menit (sebelum 6 jam mati)

jobs:
  gui:
    runs-on: macos-14
    timeout-minutes: 360

    steps:
      # 1. Checkout
      - name: Checkout
        uses: actions/checkout@v4

      # 2. Install Dependencies
      - name: Install Node.js, LocalTunnel, noVNC
        run: |
          brew install node
          npm install -g localtunnel
          git clone https://github.com/novnc/noVNC.git
          cd noVNC
          cp vnc.html index.html
          echo '<!DOCTYPE html><html><head><meta http-equiv="refresh" content="0; url=./?host=localhost&port=5901&autoconnect=true"></head></html>' > index.html

      # 3. Enable VNC + Set Password
      - name: Enable VNC
        run: |
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -activate -configure -access -on -privs -all -setvncpw -vncpw "gui12345"

      # 4. Start noVNC Web Server (port 6080)
      - name: Start noVNC
        run: |
          cd noVNC
          nohup python3 -m http.server 6080 > ../novnc.log 2>&1 &
          sleep 5
          echo "noVNC started on port 6080"

      # 5. Start LocalTunnel (HTTPS â†’ noVNC)
      - name: Start LocalTunnel
        run: |
          nohup lt --port 6080 --print-url --local-host localhost > tunnel.log 2>&1 &
          sleep 12
          URL=$(grep -o 'https://[^ ]*' tunnel.log | head -1)
          echo "TUNNEL_URL=$URL" >> $GITHUB_OUTPUT
          echo "GUI URL: $URL"
          echo "Bookmark ini: $URL"

      # 6. Show Access Info
      - name: Final URL
        run: |
          echo "=================================="
          echo "MACOS GUI 24/7 SIAP!"
          echo "=================================="
          echo "Buka di browser (HP/PC):"
          echo "$TUNNEL_URL"
          echo ""
          echo "Password VNC: gui12345"
          echo "Auto-restart tiap 5 jam 50 menit"
          echo "=================================="

      # 7. Keep Alive + Auto-Restart Hint
      - name: Keep Alive
        run: |
          echo "Runner hidup... Auto-restart via cron: */350 * * * *"
          while true; do
            sleep 300
            echo "[$(date)] Still alive... GUI: $TUNNEL_URL"
          done
