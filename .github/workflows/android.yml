name: Windows RDP Optimization V7.2

on:
  workflow_dispatch:

jobs:
  setup:
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v2

    - name: System Performance
      run: |
        powercfg /s 8c5e7fda-e8bf-4a96-9a85-a6e23a8c635c
        
        # CIM/PowerShell for Pagefile
        Set-CimInstance -Query "Select * from Win32_ComputerSystem" -Property @{AutomaticManagedPagefile=$False}
        $pagefile = Get-CimInstance -ClassName Win32_PageFileSetting -ErrorAction SilentlyContinue
        if ($pagefile) {
            Set-CimInstance -InputObject $pagefile -Property @{InitialSize=8192; MaximumSize=8192}
        } else {
            New-CimInstance -ClassName Win32_PageFileSetting -Property @{Name="C:\pagefile.sys"; InitialSize=8192; MaximumSize=8192}
        }

        # Matikan Wallpaper dan Efek Visual secara total
        $desktop = 'HKCU:\Control Panel\Desktop'
        Set-ItemProperty -Path $desktop -Name 'Wallpaper' -Value ""
        Set-ItemProperty -Path $desktop -Name 'UserPreferencesMask' -Value ([byte[]](0x90,0x12,0x01,0x80,0x10,0x00,0x00,0x00))
        Set-ItemProperty -Path $desktop -Name 'MenuShowDelay' -Value 0
        Set-ItemProperty -Path $desktop -Name 'FontSmoothing' -Value 0
        Set-ItemProperty -Path $desktop -Name 'DragFullWindows' -Value 0
        Set-ItemProperty -Path 'HKCU:\Control Panel\Colors' -Name 'Background' -Value "0 0 0"

        # Force Best Performance Mode
        $vis = 'HKCU:\Software\Microsoft\Windows\CurrentVersion\Explorer\VisualEffects'
        if (!(Test-Path $vis)) { New-Item -Path $vis -Force }
        Set-ItemProperty -Path $vis -Name 'VisualFXSetting' -Value 2

    - name: Network Tuning
      run: |
        netsh int tcp set global rss=enabled
        netsh int tcp set global autotuninglevel=normal
        
        $tcp = "HKLM:\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters\Interfaces"
        Get-ChildItem $tcp | ForEach-Object {
            New-ItemProperty -Path $_.PSPath -Name "TcpAckFrequency" -Value 1 -PropertyType DWord -Force -ErrorAction SilentlyContinue
            New-ItemProperty -Path $_.PSPath -Name "TCPNoDelay" -Value 1 -PropertyType DWord -Force -ErrorAction SilentlyContinue
        }

    - name: Android Build Config
      run: |
        $gDir = "$env:USERPROFILE\.gradle"
        if (!(Test-Path $gDir)) { New-Item -Path $gDir -ItemType Directory }
        
        @"
        org.gradle.daemon=true
        org.gradle.parallel=true
        org.gradle.configureondemand=true
        org.gradle.workers.max=4
        org.gradle.jvmargs=-Xmx10g -XX:+UseParallelGC -XX:MaxMetaspaceSize=1g -Dfile.encoding=UTF-8
        "@ | Out-File -FilePath "$gDir\gradle.properties" -Encoding ascii
        
        [Environment]::SetEnvironmentVariable("JAVA_OPTS", "-Xmx10g", "Machine")

    - name: Security & Services
      run: |
        Set-MpPreference -DisableRealtimeMonitoring $true
        Set-MpPreference -DisableBehaviorMonitoring $true
        
        $svcs = @("WSearch", "SysMain", "wuauserv", "BITS", "Themes", "WerSvc", "ShellHWDetection")
        foreach ($s in $svcs) {
            Stop-Service -Name $s -Force -ErrorAction SilentlyContinue
            Set-Service -Name $s -StartupType Disabled -ErrorAction SilentlyContinue
        }

    - name: RDP Low Latency Setup
      run: |
        $ts = 'HKLM:\System\CurrentControlSet\Control\Terminal Server'
        Set-ItemProperty -Path $ts -Name "fDenyTSConnections" -Value 0
        Set-ItemProperty -Path "$ts\WinStations\RDP-Tcp" -Name "UserAuthentication" -Value 0
        
        $rdpPol = "HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\Terminal Services"
        if (!(Test-Path $rdpPol)) { New-Item -Path $rdpPol -Force }
        Set-ItemProperty -Path $rdpPol -Name "ColorDepth" -Value 3
        Set-ItemProperty -Path $rdpPol -Name "fDisableCursorShadow" -Value 1
        Set-ItemProperty -Path $rdpPol -Name "fDisableMenuAnims" -Value 1
        Set-ItemProperty -Path $rdpPol -Name "fDisableThemes" -Value 1
        
        Set-LocalUser -Name "runneradmin" -Password (ConvertTo-SecureString -AsPlainText "p@ssw0rd!" -Force)

    - name: Tunnel
      env:
        PL_KEY: ${{ secrets.PL }}
      run: |
        $url = "https://github.com/playit-cloud/playit-agent/releases/download/v0.15.26/playit-windows-x86_64-signed.exe"
        Invoke-WebRequest -Uri $url -OutFile "$env:USERPROFILE\playit.exe"
        $p = Start-Process -FilePath "$env:USERPROFILE\playit.exe" -ArgumentList "--secret $env:PL_KEY" -WindowStyle Hidden -PassThru
        Start-Sleep -Seconds 5
        # Perbaikan: Cek apakah objek proses valid sebelum set priority
        if ($p -and $p.GetType().FullName -eq 'System.Diagnostics.Process') {
            $p.PriorityClass = [System.Diagnostics.ProcessPriorityClass]::RealTime
        }

    - name: Keep Alive
      run: |
        while ($true) {
            # Perbaikan: Gunakan foreach untuk menangani jika ada banyak proses java
            $javaProcesses = Get-Process -Name "java" -ErrorAction SilentlyContinue
            foreach ($proc in $javaProcesses) {
                if ($proc -and $proc.GetType().FullName -eq 'System.Diagnostics.Process') {
                    $proc.PriorityClass = [System.Diagnostics.ProcessPriorityClass]::High
                }
            }
            
            # Cek apakah playit masih jalan
            if (!(Get-Process -Name "playit" -ErrorAction SilentlyContinue)) {
                Start-Process -FilePath "$env:USERPROFILE\playit.exe" -ArgumentList "--secret ${{ secrets.PL }}" -WindowStyle Hidden
            }
            
            Write-Host "Monitoring... (CPU & Connection OK)"
            Start-Sleep -Seconds 60
        }
