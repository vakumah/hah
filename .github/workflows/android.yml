name: Windows-11-ARM-Android-Dev

on:
  workflow_dispatch:

jobs:
  development-android-app:
    # Menggunakan Partner Runner ARM64 (Januari 2026)
    runs-on: windows-11-arm
    timeout-minutes: 360

    steps:
    - name: OS Visual & Performa Optimization
      shell: pwsh
      run: |
        # Mengabaikan error jika registry visual gagal agar RDP tetap jalan
        $ErrorActionPreference = "SilentlyContinue"

        $themeKey = 'HKCU:\Software\Microsoft\Windows\CurrentVersion\Themes\Personalize'
        if (!(Test-Path $themeKey)) { New-Item -Path $themeKey -Force }
        Set-ItemProperty -Path $themeKey -Name 'EnableTransparency' -Value 0

        $visualKey = 'HKCU:\Control Panel\Desktop'
        Set-ItemProperty -Path $visualKey -Name 'UserPreferencesMask' -Value ([byte[]](0x90,0x12,0x01,0x80,0x10,0x00,0x00,0x00))

        $taskbarKey = 'HKCU:\Software\Microsoft\Windows\CurrentVersion\Explorer\Advanced'
        if (!(Test-Path $taskbarKey)) { New-Item -Path $taskbarKey -Force }
        Set-ItemProperty -Path $taskbarKey -Name 'TaskbarDa' -Value 0

    - name: Security & Build Performance Optimization
      shell: pwsh
      run: |
        # Mematikan Windows Defender untuk mempercepat kompilasi Gradle/Android
        Set-MpPreference -DisableRealtimeMonitoring $true
        Set-MpPreference -DisableBehaviorMonitoring $true
        Set-NetFirewallProfile -Profile Domain,Public,Private -Enabled False

    - name: Remote Desktop (RDP) Configuration
      run: |
        # Aktifkan RDP dan matikan NLA
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0
        net user runneradmin p@ssw0rd!

    - name: Initialize Network Tunnel (Optimized x64-Signed)
      env:
        PLAYIT_AUTH_KEY: ${{ secrets.PL }}
      run: |
        # Menggunakan versi signed x86_64 yang dijamin stabil di Windows 11 ARM
        $agentUrl = "https://github.com/playit-cloud/playit-agent/releases/download/v0.15.26/playit-windows-x86_64-signed.exe"
        $agentPath = "$env:USERPROFILE\playit.exe"
        
        # Download dengan verifikasi
        Invoke-WebRequest -Uri $agentUrl -OutFile $agentPath
        
        # Menjalankan tunnel dengan prioritas High
        $proc = Start-Process -FilePath $agentPath -ArgumentList "--secret $env:PLAYIT_AUTH_KEY" -WindowStyle Hidden -PassThru
        if ($proc) { $proc.PriorityClass = [System.Diagnostics.ProcessPriorityClass]::High }
        Write-Output "Android Dev Environment: Tunnel established via Signed Agent."

    - name: Keep-Live Session (6 Hours)
      shell: pwsh
      run: |
        # Sesi khusus Development Android App aktif selama 6 jam
        $endTime = (Get-Date).AddHours(6)
        while ((Get-Date) -lt $endTime) {
            $check = Get-Process -Name "playit" -ErrorAction SilentlyContinue
            if (-not $check) {
                Start-Process -FilePath "$env:USERPROFILE\playit.exe" -ArgumentList "--secret ${{ secrets.PL }}" -WindowStyle Hidden
            }
            Write-Output "Development Android App session is active... $((Get-Date).ToString())"
            Start-Sleep -Seconds 300
        }
